name: Update Japanese Datasets

on:
  schedule:
    - cron: '0 0 * * 1'  # Every Monday at 00:00 UTC (09:00 KST)

  workflow_dispatch:

jobs:
  update-datasets:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install huggingface-hub pandas tqdm

      - name: Collect Japanese datasets
        timeout-minutes: 10
        run: |
          echo "Starting dataset collection at $(date)"
          python scripts/collect_japanese_datasets.py || {
            EXIT_CODE=$?
            echo "Error: Dataset collection failed with exit code $EXIT_CODE"
            echo "Timestamp: $(date)"
            exit $EXIT_CODE
          }
          echo "Collection completed at $(date)"

      - name: Generate trend analysis
        timeout-minutes: 5
        run: |
          echo "Starting trend generation at $(date)"
          python scripts/generate_trends.py || {
            EXIT_CODE=$?
            echo "Error: Trend generation failed with exit code $EXIT_CODE"
            echo "Timestamp: $(date)"
            exit $EXIT_CODE
          }
          echo "Trend generation completed at $(date)"

      - name: Generate changelog
        timeout-minutes: 5
        run: |
          echo "Starting changelog generation at $(date)"
          python scripts/generate_changelog.py || {
            EXIT_CODE=$?
            echo "Error: Changelog generation failed with exit code $EXIT_CODE"
            echo "Timestamp: $(date)"
            exit $EXIT_CODE
          }
          echo "Changelog generation completed at $(date)"

      - name: Commit and push if changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/data/*.json docs/data/*.csv docs/data/archive/*

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Weekly update: Japanese datasets - $(date +'%Y-%m-%d %H:%M')"
            git push
          fi

      - name: Create workflow summary
        if: always()
        run: |
          echo "# ðŸ“Š Japanese Datasets Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "docs/data/japanese_datasets.json" ]; then
            DATASET_COUNT=$(python -c "import json; data=json.load(open('docs/data/japanese_datasets.json')); print(data['total_count'])")
            echo "âœ… Total datasets: **$DATASET_COUNT**" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "docs/data/statistics.json" ]; then
            DOWNLOADS=$(python -c "import json; data=json.load(open('docs/data/statistics.json')); print(f\"{data['statistics']['total_downloads']:,}\")")
            LIKES=$(python -c "import json; data=json.load(open('docs/data/statistics.json')); print(f\"{data['statistics']['total_likes']:,}\")")
            MULTILINGUAL=$(python -c "import json; data=json.load(open('docs/data/statistics.json')); print(data['statistics']['multilingual_count'])")
            echo "ðŸ“¥ Total downloads: **$DOWNLOADS**" >> $GITHUB_STEP_SUMMARY
            echo "â¤ï¸ Total likes: **$LIKES**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ Multilingual datasets: **$MULTILINGUAL**" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "docs/data/changelog.json" ]; then
            NEW_COUNT=$(python -c "import json; data=json.load(open('docs/data/changelog.json')); print(len(data['new_datasets']))")
            REMOVED_COUNT=$(python -c "import json; data=json.load(open('docs/data/changelog.json')); print(len(data['removed_datasets']))")
            UPDATED_COUNT=$(python -c "import json; data=json.load(open('docs/data/changelog.json')); print(len(data['updated_datasets']))")
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸ“ˆ Weekly Changes" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ†• New: **$NEW_COUNT**" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ Removed: **$REMOVED_COUNT**" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“ Updated: **$UPDATED_COUNT**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Catalog](https://songys.github.io/Japanese-HF-datasets-catalog/)" >> $GITHUB_STEP_SUMMARY
